openapi: 3.0.3
info:
  title: Cherry Deploy Backend API
  version: 1.0.0
  description: |
    FastAPI 기반 DevOps + 챗봇 백엔드의 전체 스펙입니다. 대부분의 엔드포인트는 로컬 Git 저장소, MongoDB,
    PM2/Nginx, Google Gemini와 상호작용하므로 실제 서버에서만 유효하게 동작합니다.
servers:
  - url: https://delight.13-125-116-92.nip.io
    description: Production (TLS via Let's Encrypt)
  - url: http://127.0.0.1:9001
    description: Local FastAPI (bypasses Nginx)
components:
  securitySchemes:
    AuthCookie:
      type: apiKey
      in: cookie
      name: auth_token
      description: `/api/v1/auth/login` 으로 발급받는 JWT 쿠키
paths:
  /api/v1/chat:
    post:
      summary: Gemini 2.5 Flash 챗봇 호출
      tags: [chat]
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Gemini 응답
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          description: 잘못된 요청
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/auth/login:
    post:
      tags: [auth]
      summary: JWT 쿠키 발급
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: 로그인 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: 자격 증명 오류
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/auth/logout:
    post:
      tags: [auth]
      summary: JWT 쿠키 삭제
      responses:
        '200':
          description: 로그아웃 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogoutResponse'
  /api/v1/auth/me:
    get:
      tags: [auth]
      summary: 현재 인증 사용자 확인
      security:
        - AuthCookie: []
      responses:
        '200':
          description: 사용자 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MeResponse'
        '401':
          description: 쿠키 없음/만료
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/deploy:
    post:
      tags: [deploy]
      summary: Blue/Green 배포 실행
      description: Repo1 `deploy`(또는 허용된 브랜치)를 최신으로 맞추고 npm build/export 후 Nginx 심볼릭 링크를 스위칭합니다.
      security:
        - AuthCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeployRequest'
      responses:
        '202':
          description: 작업이 큐에 등록됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployResponse'
        '400':
          description: 허용되지 않은 브랜치
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 작업 생성 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/rollback:
    post:
      tags: [deploy]
      summary: 최근 성공 커밋으로 롤백
      security:
        - AuthCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RollbackRequest'
      responses:
        '202':
          description: 롤백 작업이 큐에 등록됨
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployResponse'
        '400':
          description: 잘못된 입력
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: 롤백 가능한 성공 이력 부족
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/status/{task_id}:
    get:
      tags: [deploy]
      summary: 작업 상태 조회
      security:
        - AuthCookie: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 작업 상태/메타데이터
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployStatusResponse'
        '404':
          description: 작업 미존재
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/preview:
    get:
      tags: [deploy]
      summary: 배포 사전 점검
      description: 최근 성공 배포와 현재 HEAD diff, LLM 요약, 비용 추정, Blue/Green 상태를 제공합니다.
      security:
        - AuthCookie: []
      parameters:
        - in: query
          name: task_id
          schema:
            type: string
          description: 특정 작업 컨텍스트를 참고할 때 지정
      responses:
        '200':
          description: 프리뷰 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployPreviewResponse'
        '404':
          description: task_id를 찾을 수 없음
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/tasks/recent:
    get:
      tags: [deploy]
      summary: 최근 배포/롤백 목록
      security:
        - AuthCookie: []
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 20
            default: 5
      responses:
        '200':
          description: 작업 목록
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DeployTaskSummary'
  /api/v1/tasks/{task_id}/logs:
    get:
      tags: [deploy]
      summary: Stage별 로그/메타데이터 조회
      security:
        - AuthCookie: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: stage별 stdout/stderr 포함
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployTaskLogResponse'
        '404':
          description: 작업 미존재
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /healthz:
    get:
      tags: [system]
      summary: PM2/Nginx/Mongo 헬스체크
      security: []
      responses:
        '200':
          description: 헬스 상태
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatusResponse'
components:
  schemas:
    ChatRequest:
      type: object
      required: [message]
      properties:
        message:
          type: string
          minLength: 1
    ChatResponse:
      type: object
      required: [reply, model]
      properties:
        reply:
          type: string
        model:
          type: string
    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
        password:
          type: string
    LoginResponse:
      type: object
      required: [username, expires_at]
      properties:
        username:
          type: string
        expires_at:
          type: string
          format: date-time
    LogoutResponse:
      type: object
      required: [success]
      properties:
        success:
          type: boolean
    MeResponse:
      type: object
      required: [username]
      properties:
        username:
          type: string
    DeployRequest:
      type: object
      properties:
        branch:
          type: string
          description: 허용된 브랜치(`deploy`, `main`).
    RollbackRequest:
      type: object
      properties:
        branch:
          type: string
          description: 롤백 대상 브랜치 (선택).
    DeployResponse:
      type: object
      required:
        - task_id
        - status
        - branch
        - action
        - queued_at
        - estimated_duration_minutes
        - context
        - dev_server_restart_planned
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/DeployStatusEnum'
        branch:
          type: string
        action:
          type: string
          enum: [deploy, rollback]
        queued_at:
          type: string
          format: date-time
        estimated_duration_minutes:
          type: integer
        context:
          type: object
          additionalProperties: true
        dev_server_restart_planned:
          type: boolean
    DeployStatusResponse:
      type: object
      required: [task_id, status, metadata, stages, started_at]
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/DeployStatusEnum'
        metadata:
          type: object
          additionalProperties: true
        stages:
          type: object
          additionalProperties:
            type: object
            additionalProperties: true
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        error_log:
          type: string
          nullable: true
        failure_context:
          type: object
          nullable: true
          additionalProperties: true
        cost_estimate:
          type: object
          nullable: true
          additionalProperties: true
        risk_assessment:
          type: object
          nullable: true
          additionalProperties: true
        llm_preview:
          $ref: '#/components/schemas/LLMPreview'
          nullable: true
        blue_green_plan:
          $ref: '#/components/schemas/BlueGreenPlan'
          nullable: true
        timezone:
          type: string
    DeployPreviewResponse:
      type: object
      required:
        - current_branch
        - target_repo
        - commands
        - risk_assessment
        - cost_estimate
        - llm_preview
        - timeline_preview
        - warnings
        - blue_green_plan
        - diff_source
        - diff_stats
      properties:
        current_branch:
          type: string
        target_repo:
          type: string
        frontend_project_path:
          type: string
          nullable: true
        frontend_output_path:
          type: string
          nullable: true
        commands:
          type: array
          items:
            type: string
        risk_assessment:
          type: object
          additionalProperties: true
        cost_estimate:
          type: object
          additionalProperties: true
        llm_preview:
          $ref: '#/components/schemas/LLMPreview'
        timeline_preview:
          type: array
          items:
            $ref: '#/components/schemas/TimelineEntry'
        warnings:
          type: array
          items:
            type: string
        task_context:
          type: object
          nullable: true
          additionalProperties: true
        blue_green_plan:
          $ref: '#/components/schemas/BlueGreenPlan'
        diff_source:
          type: string
          enum: [working_tree, github_compare]
        diff_stats:
          type: object
          additionalProperties: true
        compare_metadata:
          type: object
          nullable: true
          additionalProperties: true
    DeployTaskSummary:
      type: object
      required: [task_id, status, branch, action, started_at]
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/DeployStatusEnum'
        branch:
          type: string
        action:
          type: string
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        actor:
          type: string
          nullable: true
        timezone:
          type: string
          nullable: true
        summary:
          type: object
          nullable: true
          additionalProperties: true
        failure_context:
          type: object
          nullable: true
          additionalProperties: true
    DeployTaskLogResponse:
      type: object
      required: [task_id, status, stages, metadata]
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/DeployStatusEnum'
        stages:
          type: object
          additionalProperties:
            type: object
            additionalProperties: true
        metadata:
          type: object
          additionalProperties: true
        error_log:
          type: string
          nullable: true
        failure_context:
          type: object
          nullable: true
          additionalProperties: true
    HealthStatusResponse:
      type: object
      required: [status, pm2_processes, mongo, issues, blue_green]
      properties:
        status:
          type: string
        pm2_processes:
          type: object
          additionalProperties:
            type: string
        mongo:
          type: string
        last_task_id:
          type: string
          nullable: true
        last_task_status:
          $ref: '#/components/schemas/DeployStatusEnum'
          nullable: true
        issues:
          type: array
          items:
            type: string
        blue_green:
          $ref: '#/components/schemas/BlueGreenPlan'
    LLMPreview:
      type: object
      required: [summary, highlights, risks]
      properties:
        summary:
          type: string
        highlights:
          type: array
          items:
            type: string
        risks:
          type: array
          items:
            type: string
    TimelineEntry:
      type: object
      required: [stage, label, status]
      properties:
        stage:
          type: string
        label:
          type: string
        expected_seconds:
          type: integer
          nullable: true
        completed:
          type: boolean
          nullable: true
        status:
          type: string
          enum: [completed, upcoming, pending]
        metadata:
          type: object
          nullable: true
          additionalProperties: true
    BlueGreenPlan:
      type: object
      required: [active_slot, next_cutover_target]
      properties:
        active_slot:
          type: string
        standby_slot:
          type: string
          nullable: true
        last_cutover_at:
          type: string
          nullable: true
        next_cutover_target:
          type: string
    DeployStatusEnum:
      type: string
      enum: [pending, running_clone, running_build, running_cutover, running_observability, completed, failed]
    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
