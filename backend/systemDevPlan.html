<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.65; padding: 24px; max-width: 1000px; margin: auto; background-color: #ffffff; color: #1f1f1f; border: 1px solid #e3e3e3;">
  <h1 style="font-size: 30px; border-bottom: 2px solid #111; padding-bottom: 10px; margin-top: 0;">
    ğŸš€ System Design Â· Cherry Deploy (ìµœì¢… êµ¬í˜„)
  </h1>

  <h2 style="font-size: 24px; margin-top: 28px;">1. ì „ë°˜ êµ¬ì¡°</h2>
  <p>ëª¨ë“  DevOps + ì±—ë´‡ APIëŠ” FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜(<code>app_main.py</code>) í•œ ê³³ì— í†µí•©ë˜ì–´ ìˆìœ¼ë©°, <strong>Repo2</strong>ê°€ Repo1(Next.js íƒ€ê²Ÿ)ì„ ì§ì ‘ ì¡°ì‘í•©ë‹ˆë‹¤.</p>
  <pre style="background:#fafafa; border:1px solid #ddd; padding:16px; border-radius:6px; overflow:auto;">
/home/ec2-user/projects/
â”œâ”€ SB_Hackathon_Cherry_Chatbot (Repo1, Next.js ëŒ€ìƒ)
â”‚   â””â”€ frontend/my-dashboard  â† npm install/build/export ëŒ€ìƒ
â””â”€ SB_Hackathon_Cherry_Deploy (Repo2, ë³¸ í”„ë¡œì íŠ¸)
    â”œâ”€ app_main.py            â† FastAPI ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸
    â”œâ”€ api-code/              â† services/routers/repositories/schemas
    â”œâ”€ mongodb/, mongodb-data â† ë¡œì»¬ MongoDB ë²ˆë“¤
    â””â”€ swagger-api/           â† OpenAPI ë¬¸ì„œ ì„¸íŠ¸
  </pre>
  <ul>
    <li><strong>Infra</strong>: AWS EC2 + PM2 + Nginx(Blue/Green) + ë¡œì»¬ MongoDB + Gemini API.</li>
    <li><strong>í”„ë¡œì„¸ìŠ¤</strong>: PM2ê°€ <code>uvicorn app_main:app</code> ë¥¼ <code>main-api</code> ì´ë¦„ìœ¼ë¡œ ì‹¤í–‰.</li>
    <li><strong>ì ‘ê·¼ ì œì–´</strong>: ëª¨ë“  DevOps ì—”ë“œí¬ì¸íŠ¸ëŠ” JWT ì¿ í‚¤(<code>auth_token</code>) ì¸ì¦ í•„ìˆ˜.</li>
  </ul>

  <h2 style="font-size: 24px; margin-top: 28px;">2. ì„œë¹„ìŠ¤/ëª¨ë“ˆ ì„¤ê³„</h2>
  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="background:#f7f7f7;">
        <th style="border:1px solid #ddd; padding:8px;">ëª¨ë“ˆ</th>
        <th style="border:1px solid #ddd; padding:8px;">ì—­í• </th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td style="border:1px solid #ddd; padding:8px;">`settings.py`</td>
        <td style="border:1px solid #ddd; padding:8px;">í™˜ê²½ ë³€ìˆ˜ â†’ Pydantic ëª¨ë¸. Git ê²½ë¡œ, Blue/Green ê²½ë¡œ, LLM ì˜µì…˜, ì¸ì¦ ê°’ ë“±ì„ ë‹¨ì¼ ì†ŒìŠ¤ì—ì„œ ê´€ë¦¬.</td>
      </tr>
      <tr>
        <td style="border:1px solid #ddd; padding:8px;">`services/auth_service.py`</td>
        <td style="border:1px solid #ddd; padding:8px;">ê³ ì • ê³„ì • ê²€ì¦, JWT ì¿ í‚¤ ë°œê¸‰/ì‚­ì œ, FastAPI ì˜ì¡´ì„±ìœ¼ë¡œ ì „ë‹¬.</td>
      </tr>
      <tr>
        <td style="border:1px solid #ddd; padding:8px;">`services/gemini_chat_service.py`</td>
        <td style="border:1px solid #ddd; padding:8px;">Gemini 2.5 Flash í˜¸ì¶œ ë˜í¼, í‚¤ ì—†ì„ ë•Œ fallback ì‘ë‹µ.</td>
      </tr>
      <tr>
        <td style="border:1px solid #ddd; padding:8px;">`services/deploy_service.py`</td>
        <td style="border:1px solid #ddd; padding:8px;">ë°°í¬/ë¡¤ë°± íŒŒì´í”„ë¼ì¸, AsyncReentrantLock, auto rollback, í”„ë¦¬ë·°, stage ë¡œê·¸, Mongo ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸.</td>
      </tr>
      <tr>
        <td style="border:1px solid #ddd; padding:8px;">`repositories/deploy_tasks.py`</td>
        <td style="border:1px solid #ddd; padding:8px;">Motor ê¸°ë°˜ Mongo Repo (`deploy_tasks`, `deploy_reports`). ì¸ë±ìŠ¤/ìµœê·¼ ì¡°íšŒ/ì„±ê³µ ì´ë ¥ ë¡œì§ í¬í•¨. ì‹¤íŒ¨ ì‹œ in-memory í´ë°±.</td>
      </tr>
      <tr>
        <td style="border:1px solid #ddd; padding:8px;">`routers/*.py`</td>
        <td style="border:1px solid #ddd; padding:8px;">Chat, Auth, Deploy, Health ë¼ìš°í„° ë¶„ë¦¬. ì¸ì¦ ì˜ì¡´ì„±ì€ Deploy/Status/Preview/Tasks/Logs/Rollbackì—ë§Œ ì£¼ì….</td>
      </tr>
    </tbody>
  </table>

  <h2 style="font-size: 24px; margin-top: 28px;">3. ë°°í¬ íŒŒì´í”„ë¼ì¸</h2>
  <ol style="margin-left:20px;">
    <li><strong>running_clone</strong>: Repo1ì—ì„œ <code>git fetch â†’ checkout -B {branch} â†’ reset --hard â†’ clean -fdx</code>. ë¡¤ë°± ì‹œ íŠ¹ì • ì»¤ë°‹ ê°•ì œ checkout ë° push ì˜µì…˜.</li>
    <li><strong>running_build</strong>: `FRONTEND_INSTALL_COMMAND`, `FRONTEND_BUILD_COMMAND`, `FRONTEND_EXPORT_COMMAND` ìˆœì„œ ì‹¤í–‰. dry-run ëª¨ë“œì¼ ê²½ìš° ëª…ë ¹ë§Œ ê¸°ë¡.</li>
    <li><strong>running_cutover</strong>: Blue â†” Green ë””ë ‰í„°ë¦¬ ì¤‘ standbyì— ë¹Œë“œ ì‚°ì¶œë¬¼ì„ ë³µì‚¬í•˜ê³  <code>/var/www/cherry-deploy/current</code> ì‹¬ë³¼ë¦­ ë§í¬ ìŠ¤ìœ„ì¹­. dev-server ëª¨ë“œë©´ Skip.</li>
    <li><strong>running_observability</strong>: í–¥í›„ í™•ì¥ìš© placeholder. í˜„ì¬ëŠ” ì„±ê³µ ë©”ì‹œì§€ë§Œ ë°˜í™˜.</li>
  </ol>
  <p>ê° ë‹¨ê³„ëŠ” Mongo ë©”íƒ€ë°ì´í„°ì— stdout/stderr/returncode/ëª…ë ¹ ì„¤ëª…ì„ ê¸°ë¡í•˜ë©°, ì‹¤íŒ¨ ì‹œ `failure_context`ì— ì¬ì‹œë„/auto_recovery ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.</p>

  <h2 style="font-size: 24px; margin-top: 28px;">4. ë°ì´í„° ë° ë™ì‹œì„±</h2>
  <ul>
    <li><strong>DeployTask</strong>: `_id`, `status`, `started_at/completed_at`, stage ë©”íƒ€ë°ì´í„°, summary, failure_context.</li>
    <li><strong>AsyncReentrantLock</strong>: FastAPI BackgroundTask ì•ˆì—ì„œ ì‚¬ìš©í•˜ì—¬ í•˜ë‚˜ì˜ EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë™ì‹œ ë°°í¬ë¥¼ ì§ë ¬í™”.</li>
    <li><strong>Auto rollback</strong>: `npm install`, `pm2 start` ë“± ì£¼ìš” ëª…ë ¹ ì‹¤íŒ¨ ì‹œ ìµœê·¼ ì„±ê³µ 2ê±´ ê¸°ë°˜ìœ¼ë¡œ ìë™ ë¡¤ë°± íŒŒì´í”„ë¼ì¸ ì‹¤í–‰.</li>
  </ul>

  <h2 style="font-size: 24px; margin-top: 28px;">5. ì¸ì¦ & ë³´ì•ˆ</h2>
  <ul>
    <li>ê³„ì •ì€ í™˜ê²½ë³€ìˆ˜ <code>LOGIN_USER</code>/<code>LOGIN_PASSWORD</code>ë¡œ ì •ì˜.</li>
    <li><code>JWT_SECRET_KEY</code> ë¯¸ì„¤ì • ì‹œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ê¸°ë™ì„ ê±°ë¶€.</li>
    <li><code>auth_token</code> ì¿ í‚¤(HTTPOnly, Secure, SameSite=Lax)ë¥¼ ì´ìš©í•˜ì—¬ `/api/v1/*`(chat ì œì™¸)ì„ ë³´í˜¸.</li>
    <li>ëª¨ë“  ë¯¼ê° ëª…ë ¹ì€ ì„œë²„ ë‚´ë¶€ì—ì„œë§Œ ì‹¤í–‰ë˜ë©° ì™¸ë¶€ë¡œ ë…¸ì¶œë˜ì§€ ì•ŠìŒ.</li>
  </ul>

  <h2 style="font-size: 24px; margin-top: 28px;">6. API ìš”ì•½ (ìµœì¢… 12ê°œ)</h2>
  <table style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="background:#f7f7f7;">
        <th style="border:1px solid #ddd; padding:8px;">êµ¬ë¶„</th>
        <th style="border:1px solid #ddd; padding:8px;">Method & Path</th>
        <th style="border:1px solid #ddd; padding:8px;">ì„¤ëª…</th>
        <th style="border:1px solid #ddd; padding:8px;">ì¸ì¦</th>
      </tr>
    </thead>
    <tbody>
      <tr><td rowspan="4" style="border:1px solid #ddd; padding:8px;">Deploy</td><td style="border:1px solid #ddd; padding:8px;">POST /api/v1/deploy</td><td style="border:1px solid #ddd; padding:8px;">Blue/Green ë°°í¬ ì‹œì‘</td><td style="border:1px solid #ddd; padding:8px;">í•„ìˆ˜</td></tr>
      <tr><td style="border:1px solid #ddd; padding:8px;">POST /api/v1/rollback</td><td style="border:1px solid #ddd; padding:8px;">ì§ì „ ì„±ê³µ ë°°í¬ë¡œ ë³µê·€</td><td style="border:1px solid #ddd; padding:8px;">í•„ìˆ˜</td></tr>
      <tr><td style="border:1px solid #ddd; padding:8px;">GET /api/v1/tasks/recent</td><td style="border:1px solid #ddd; padding:8px;">ìµœê·¼ ë°°í¬/ë¡¤ë°± íˆìŠ¤í† ë¦¬</td><td style="border:1px solid #ddd; padding:8px;">í•„ìˆ˜</td></tr>
      <tr><td style="border:1px solid #ddd; padding:8px;">GET /api/v1/tasks/{id}/logs</td><td style="border:1px solid #ddd; padding:8px;">stage ë¡œê·¸/ë©”íƒ€ë°ì´í„°</td><td style="border:1px solid #ddd; padding:8px;">í•„ìˆ˜</td></tr>
      <tr><td rowspan="2" style="border:1px solid #ddd; padding:8px;">Status</td><td style="border:1px solid #ddd; padding:8px;">GET /api/v1/status/{id}</td><td style="border:1px solid #ddd; padding:8px;">ì§„í–‰ ìƒí™© + ë¹„ìš©/ìœ„í—˜</td><td style="border:1px solid #ddd; padding:8px;">í•„ìˆ˜</td></tr>
      <tr><td style="border:1px solid #ddd; padding:8px;">GET /api/v1/preview</td><td style="border:1px solid #ddd; padding:8px;">LLM ìš”ì•½/ëª…ë ¹/ETA</td><td style="border:1px solid #ddd; padding:8px;">í•„ìˆ˜</td></tr>
      <tr><td rowspan="3" style="border:1px solid #ddd; padding:8px;">Auth</td><td style="border:1px solid #ddd; padding:8px;">POST /api/v1/auth/login</td><td style="border:1px solid #ddd; padding:8px;">JWT ì¿ í‚¤ ë°œê¸‰</td><td style="border:1px solid #ddd; padding:8px;">-</td></tr>
      <tr><td style="border:1px solid #ddd; padding:8px;">POST /api/v1/auth/logout</td><td style="border:1px solid #ddd; padding:8px;">ì¿ í‚¤ ì‚­ì œ</td><td style="border:1px solid #ddd; padding:8px;">-</td></tr>
      <tr><td style="border:1px solid #ddd; padding:8px;">GET /api/v1/auth/me</td><td style="border:1px solid #ddd; padding:8px;">í˜„ì¬ ì‚¬ìš©ì í™•ì¸</td><td style="border:1px solid #ddd; padding:8px;">í•„ìˆ˜</td></tr>
      <tr><td style="border:1px solid #ddd; padding:8px;">Chat</td><td style="border:1px solid #ddd; padding:8px;">POST /api/v1/chat</td><td style="border:1px solid #ddd; padding:8px;">Gemini ì‘ë‹µ í”„ë¡ì‹œ</td><td style="border:1px solid #ddd; padding:8px;">ë¶ˆí•„ìš”</td></tr>
      <tr><td style="border:1px solid #ddd; padding:8px;">System</td><td style="border:1px solid #ddd; padding:8px;">GET /healthz</td><td style="border:1px solid #ddd; padding:8px;">Mongo/PM2/Nginx ìƒíƒœ ì¢…í•©</td><td style="border:1px solid #ddd; padding:8px;">ë¶ˆí•„ìš”</td></tr>
    </tbody>
  </table>

  <h2 style="font-size: 24px; margin-top: 28px;">7. ì¥ì•  ëŒ€ì‘ ì‹œë‚˜ë¦¬ì˜¤</h2>
  <ul>
    <li><strong>Git ì»¤ë§¨ë“œ ì‹¤íŒ¨</strong>: `CommandExecutionError`ì— stdout/stderr/returncode ì €ì¥ â†’ /tasks/logs ë¡œ ê°€ì‹œí™”.</li>
    <li><strong>npm install ì‹¤íŒ¨</strong>: auto rollback ì‹œë„ â†’ ì„±ê³µ ì‹œ `failure_context.auto_recovery`ì— ê²°ê³¼ ê¸°ë¡.</li>
    <li><strong>Mongo ì¥ì• </strong>: startup ì—ì„œ in-memory repoë¡œ í´ë°±, `/healthz`ì— `mongo: unreachable` í‘œì‹œ.</li>
    <li><strong>LLM ì‹¤íŒ¨</strong>: ë¡œê·¸ ê²½ê³  í›„ fallback ìš”ì•½(â€œDiff context unavailable â€¦â€) ë°˜í™˜.</li>
  </ul>

  <p style="margin-top:36px; font-weight:bold; text-align:center;">ì´ ì„¤ê³„ ë¬¸ì„œë§Œìœ¼ë¡œ ì‹ ê·œ ì¸ì›ì´ ì „ì²´ ì‹œìŠ¤í…œ(ì½”ë“œ â†’ ì¸í”„ë¼ â†’ API) êµ¬ì¡°ë¥¼ 95% ì´ìƒ ì´í•´í•˜ë„ë¡ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
</div>
