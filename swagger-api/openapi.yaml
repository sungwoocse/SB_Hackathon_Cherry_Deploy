openapi: 3.0.3
info:
  title: Cherry Deploy Backend API
  version: 0.1.0
  description: |
    Unified specification combining chatbot and DevOps endpoints. Requires the live FastAPI backend for
    actual execution because several endpoints depend on background tasks, local repositories, and MongoDB.
servers:
  - url: https://delight.13-125-116-92.nip.io
    description: Production-like endpoint (HTTPS via Let's Encrypt)
  - url: http://127.0.0.1:9001
    description: Local FastAPI server (bypasses Nginx)
paths:
  /api/v1/chat:
    post:
      summary: Send a user message and receive a Gemini-generated reply.
      tags: [chat]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              basic:
                summary: Basic greeting
                value:
                  message: "안녕하세요! 배포 상황이 어떤지 알려주세요."
      responses:
        '200':
          description: Gemini replied successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          description: Invalid prompt payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/deploy:
    post:
      summary: Trigger a chatbot frontend deployment
      description: Requires a valid auth_token cookie issued by /api/v1/auth/login.
      tags: [deploy]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeployRequest'
            example:
              branch: deploy
      responses:
        '202':
          description: Deployment accepted; background task scheduled.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployResponse'
        '400':
          description: Branch not allowed or payload invalid.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Server error prevented task creation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/status/{task_id}:
    get:
      summary: Fetch current deployment status
      description: Requires a valid auth_token cookie issued by /api/v1/auth/login.
      tags: [deploy]
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task found; returns status and metadata.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployStatusResponse'
        '404':
          description: Task not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/preview:
    get:
      summary: Describe upcoming deploy steps, risks, and costs
      description: >
        Requires a valid auth_token cookie. Returns risk/cost estimates, warnings, and timeline data using diff
        statistics from the local working tree or (when configured) the GitHub Compare API with a short-lived
        cache/fallback.
      tags: [deploy]
      parameters:
        - in: query
          name: task_id
          schema:
            type: string
          description: Optional task identifier to align the preview timeline with a specific run.
      responses:
        '200':
          description: Static preview payload showing operational context.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployPreviewResponse'
        '404':
          description: task_id provided but task metadata missing.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/rollback:
    post:
      summary: Roll back to the previous successful deployment commit
      description: Requires a valid auth_token cookie issued by /api/v1/auth/login.
      tags: [deploy]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RollbackRequest'
      responses:
        '202':
          description: Rollback accepted; background task scheduled.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployResponse'
        '400':
          description: Invalid rollback request.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Not enough history to perform rollback.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/tasks/recent:
    get:
      summary: List recent deploy/rollback tasks
      description: Requires a valid auth_token cookie issued by /api/v1/auth/login.
      tags: [deploy]
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 20
            default: 5
          description: Maximum number of recent tasks to return (clamped to 20).
      responses:
        '200':
          description: Recent tasks ordered by start time (newest first).
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DeployTaskSummary'
  /api/v1/tasks/{task_id}/logs:
    get:
      summary: Detailed stdout/stderr metadata for a specific task
      description: Requires a valid auth_token cookie issued by /api/v1/auth/login.
      tags: [deploy]
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task metadata with captured stdout/stderr snippets.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployTaskLogResponse'
        '404':
          description: Task not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/auth/login:
    post:
      summary: Authenticate operator and set auth cookie
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Credentials accepted; cookie issued via Set-Cookie header.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Invalid credentials.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/auth/logout:
    post:
      summary: Clear auth cookie
      tags: [auth]
      responses:
        '200':
          description: Cookie removed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogoutResponse'
  /api/v1/auth/me:
    get:
      summary: Return current authenticated user
      tags: [auth]
      responses:
        '200':
          description: Cookie decoded successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MeResponse'
        '401':
          description: Missing or invalid auth cookie.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /healthz:
    get:
      summary: Liveness probe
      tags: [system]
      responses:
        '200':
          description: Service alive indicator including PM2 and Mongo checks.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatusResponse'
components:
  schemas:
    ChatRequest:
      type: object
      required: [message]
      properties:
        message:
          type: string
          minLength: 1
          description: User message forwarded to Gemini 2.5 Flash.
    ChatResponse:
      type: object
      required: [reply, model]
      properties:
        reply:
          type: string
        model:
          type: string
    DeployRequest:
      type: object
      properties:
        branch:
          type: string
          description: "Optional override for the deployment branch (default: deploy)."
          example: deploy
    DeployResponse:
      type: object
      required:
        - task_id
        - status
        - branch
        - action
        - queued_at
        - estimated_duration_minutes
        - context
        - dev_server_restart_planned
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/DeployStatusEnum'
        branch:
          type: string
          description: Branch resolved for this deployment or rollback.
        action:
          type: string
          enum: [deploy, rollback]
        queued_at:
          type: string
          format: date-time
        estimated_duration_minutes:
          type: integer
          minimum: 1
          description: Rough ETA derived from diff statistics.
        context:
          type: object
          additionalProperties: true
        dev_server_restart_planned:
          type: boolean
          description: True when the pipeline restarts the long-running dev server instead of copying static assets.
    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          description: Operator username configured via LOGIN_USER.
        password:
          type: string
          description: Operator password configured via LOGIN_PASSWORD.
    LoginResponse:
      type: object
      required: [username, expires_at]
      properties:
        username:
          type: string
        expires_at:
          type: string
          format: date-time
          description: Expiration timestamp for the issued JWT cookie.
    LogoutResponse:
      type: object
      required: [success]
      properties:
        success:
          type: boolean
          description: True when the cookie is cleared.
    MeResponse:
      type: object
      required: [username]
      properties:
        username:
          type: string
          description: Authenticated username derived from the auth cookie.
    DeployStatusResponse:
      type: object
      required: [task_id, status, metadata, stages, started_at]
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/DeployStatusEnum'
        metadata:
          type: object
          additionalProperties: true
        stages:
          type: object
          additionalProperties:
            type: object
            additionalProperties: true
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        error_log:
          type: string
          nullable: true
        failure_context:
          type: object
          nullable: true
          additionalProperties: true
        cost_estimate:
          type: object
          additionalProperties: true
          nullable: true
        risk_assessment:
          type: object
          additionalProperties: true
          nullable: true
        llm_preview:
          $ref: '#/components/schemas/LLMPreview'
          nullable: true
        blue_green_plan:
          $ref: '#/components/schemas/BlueGreenPlan'
          nullable: true
        timezone:
          type: string
          description: IANA timezone identifier for datetime fields (e.g., Asia/Seoul).
    DeployPreviewResponse:
      type: object
      required:
        - current_branch
        - target_repo
        - commands
        - risk_assessment
        - cost_estimate
        - timeline_preview
        - warnings
        - blue_green_plan
        - diff_source
        - diff_stats
      properties:
        current_branch:
          type: string
        target_repo:
          type: string
        frontend_project_path:
          type: string
          nullable: true
        frontend_output_path:
          type: string
          nullable: true
        commands:
          type: array
          items:
            type: string
          example:
            - "git fetch origin"
            - "git checkout -B deploy origin/deploy"
            - "git reset --hard origin/deploy"
            - "git clean -fdx"
            - "npm install"
            - "bash -lc \"npm run build\""
            - "npm run export"
            - "sync static assets to nginx green path"
        risk_assessment:
          type: object
          additionalProperties: true
        cost_estimate:
          type: object
          additionalProperties: true
        llm_preview:
          $ref: '#/components/schemas/LLMPreview'
          nullable: true
        timeline_preview:
          type: array
          items:
            $ref: '#/components/schemas/DeployTimelineEntry'
        warnings:
          type: array
          items:
            type: string
        task_context:
          $ref: '#/components/schemas/DeployTaskSummary'
          nullable: true
        blue_green_plan:
          $ref: '#/components/schemas/BlueGreenPlan'
        diff_source:
          type: string
          description: Indicates whether diff stats come from the local working tree or the GitHub Compare API.
          enum: [working_tree, github_compare]
        diff_stats:
          type: object
          additionalProperties: true
          description: Aggregated diff summary (file counts, sensitivity flags, derived warnings).
        compare_metadata:
          type: object
          nullable: true
          additionalProperties: true
          description: Present when diff_source=github_compare and contains ahead/behind counts plus compare URLs.
    RollbackRequest:
      type: object
      properties:
        branch:
          type: string
          description: Optional override for repo1 branch (defaults to deploy).
          example: deploy
    DeployStatusEnum:
      type: string
      enum:
        - pending
        - running_clone
        - running_build
        - running_cutover
        - running_observability
        - completed
        - failed
    ErrorResponse:
      type: object
      required: [detail]
      properties:
        detail:
          type: string
    DeployTimelineEntry:
      type: object
      required: [stage, label, completed, status]
      properties:
        stage:
          $ref: '#/components/schemas/DeployStatusEnum'
        label:
          type: string
        expected_seconds:
          type: integer
          minimum: 0
          nullable: true
        completed:
          type: boolean
        status:
          type: string
          description: Stage progression indicator.
          enum: [completed, upcoming, pending]
        metadata:
          type: object
          nullable: true
          additionalProperties: true
    DeployTaskSummary:
      type: object
      required:
        - task_id
        - status
        - branch
        - action
        - started_at
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/DeployStatusEnum'
        branch:
          type: string
        action:
          type: string
          description: Operation type (deploy or rollback).
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        actor:
          type: string
          nullable: true
          description: Operator or requester associated with the task.
        timezone:
          type: string
          nullable: true
          description: IANA timezone identifier for datetime fields.
        summary:
          type: object
          nullable: true
          additionalProperties: true
        failure_context:
          type: object
          nullable: true
          additionalProperties: true
    DeployTaskLogResponse:
      type: object
      required:
        - task_id
        - status
        - stages
        - metadata
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/DeployStatusEnum'
        stages:
          type: object
          additionalProperties:
            type: object
            additionalProperties: true
        metadata:
          type: object
          additionalProperties: true
        error_log:
          type: string
          nullable: true
        failure_context:
          type: object
          nullable: true
          additionalProperties: true
    HealthStatusResponse:
      type: object
      required: [status, pm2_processes, mongo, issues]
      properties:
        status:
          type: string
          description: "healthy when all checks pass, otherwise degraded."
        pm2_processes:
          type: object
          additionalProperties:
            type: string
          description: Map of PM2 process names to their states.
        mongo:
          type: string
          description: Result of the MongoDB ping command.
        last_task_id:
          type: string
          nullable: true
        last_task_status:
          $ref: '#/components/schemas/DeployStatusEnum'
          nullable: true
        issues:
          type: array
          items:
            type: string
        blue_green:
          $ref: '#/components/schemas/BlueGreenPlan'
    LLMPreview:
      type: object
      required: [summary, highlights, risks]
      properties:
        summary:
          type: string
        highlights:
          type: array
          items:
            type: string
        risks:
          type: array
          items:
            type: string
    BlueGreenPlan:
      type: object
      required: [active_slot, next_cutover_target]
      properties:
        active_slot:
          type: string
          description: Currently serving color (green/blue/dev-server/unknown).
        standby_slot:
          type: string
          nullable: true
          description: Idle slot that will be served next if a cutover occurs.
        last_cutover_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp of the most recent completed cutover, if known.
        next_cutover_target:
          type: string
          nullable: true
          description: Slot targeted for the next cutover step.
