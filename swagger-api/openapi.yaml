openapi: 3.0.3
info:
  title: Cherry Deploy Backend API
  version: 0.1.0
  description: |
    Unified specification combining chatbot and DevOps endpoints. Requires the live FastAPI backend for
    actual execution because several endpoints depend on background tasks, local repositories, and MongoDB.
servers:
  - url: https://delight.13-125-116-92.nip.io
    description: Production-like endpoint (HTTPS via Let's Encrypt)
  - url: http://127.0.0.1:9001
    description: Local FastAPI server (bypasses Nginx)
paths:
  /api/v1/chat:
    post:
      summary: Send a user message and receive a Gemini-generated reply.
      tags: [chat]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              basic:
                summary: Basic greeting
                value:
                  message: "안녕하세요! 배포 상황이 어떤지 알려주세요."
      responses:
        '200':
          description: Gemini replied successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          description: Invalid prompt payload.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/deploy:
    post:
      summary: Trigger a chatbot frontend deployment
      tags: [deploy]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeployRequest'
            example:
              branch: deploy
      responses:
        '202':
          description: Deployment accepted; background task scheduled.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployResponse'
        '500':
          description: Server error prevented task creation.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/status/{task_id}:
    get:
      summary: Fetch current deployment status
      tags: [deploy]
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task found; returns status and metadata.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployStatusResponse'
        '404':
          description: Task not found.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/v1/preview:
    get:
      summary: Describe upcoming deploy steps, risks, and costs
      tags: [deploy]
      responses:
        '200':
          description: Static preview payload showing operational context.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployPreviewResponse'
  /api/v1/rollback:
    post:
      summary: Roll back to the previous successful deployment commit
      tags: [deploy]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RollbackRequest'
      responses:
        '202':
          description: Rollback accepted; background task scheduled.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeployResponse'
        '400':
          description: Invalid rollback request.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Not enough history to perform rollback.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /healthz:
    get:
      summary: Liveness probe
      tags: [system]
      responses:
        '200':
          description: Service alive indicator.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
components:
  schemas:
    ChatRequest:
      type: object
      required: [message]
      properties:
        message:
          type: string
          minLength: 1
          description: User message forwarded to Gemini 2.5 Flash.
    ChatResponse:
      type: object
      required: [reply, model]
      properties:
        reply:
          type: string
        model:
          type: string
    DeployRequest:
      type: object
      properties:
        branch:
          type: string
          description: "Optional override for the deployment branch (default: deploy)."
          example: deploy
    DeployResponse:
      type: object
      required: [task_id, status]
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/DeployStatusEnum'
    DeployStatusResponse:
      type: object
      required: [task_id, status, metadata, started_at]
      properties:
        task_id:
          type: string
        status:
          $ref: '#/components/schemas/DeployStatusEnum'
        metadata:
          type: object
          additionalProperties: true
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        error_log:
          type: string
          nullable: true
    DeployPreviewResponse:
      type: object
      required:
        - current_branch
        - target_repo
        - commands
        - risk_assessment
        - cost_estimate
      properties:
        current_branch:
          type: string
        target_repo:
          type: string
        frontend_project_path:
          type: string
          nullable: true
        frontend_output_path:
          type: string
          nullable: true
        commands:
          type: array
          items:
            type: string
          example:
            - "git fetch origin"
            - "git checkout -B deploy origin/deploy"
            - "git reset --hard origin/deploy"
            - "git clean -fdx"
            - "npm install"
            - "bash -lc pm2 delete frontend-dev 2>/dev/null || true; pm2 start npm --name frontend-dev -- run dev -- --hostname 0.0.0.0 --port 3000"
            - "no static cutover (dev-server mode)"
        risk_assessment:
          type: object
          additionalProperties: true
        cost_estimate:
          type: object
          additionalProperties: true
        llm_preview:
          type: object
          nullable: true
          additionalProperties: true
    RollbackRequest:
      type: object
      properties:
        branch:
          type: string
          description: Optional override for repo1 branch (defaults to deploy).
          example: deploy
    DeployStatusEnum:
      type: string
      enum:
        - pending
        - running_clone
        - running_build
        - running_cutover
        - running_observability
        - completed
        - failed
    ErrorResponse:
      type: object
      required: [detail]
      properties:
        detail:
          type: string
